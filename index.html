<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BebCom Delivery - Produ√ß√£o</title>

    <style>
        /* ESTILOS EXISTENTES (mantenha todos os estilos anteriores) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        /* ... (mantenha todos os outros estilos do arquivo original) ... */
        
        /* ADICIONE ESTES ESTILOS NO FINAL DO CSS */
        .diagnostic-button {
            position: fixed;
            bottom: 20px;
            right: 80px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
        }
        
        .diagnostic-button:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .connection-status {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9997;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #333;
        }
        
        .connection-status.online {
            color: #10b981;
            border-color: #10b981;
        }
        
        .connection-status.offline {
            color: #ef4444;
            border-color: #ef4444;
        }
        
        .connection-status.connecting {
            color: #f59e0b;
            border-color: #f59e0b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .diagnostic-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10002;
            padding: 20px;
            overflow-y: auto;
            color: white;
        }
        
        .diagnostic-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #3b82f6;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .diagnostic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3b82f6;
        }
        
        .diagnostic-title {
            color: #60a5fa;
            font-size: 24px;
            font-weight: bold;
        }
        
        .diagnostic-close {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .test-result {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #444;
        }
        
        .test-result.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .test-result.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .test-result.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .test-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-connecting { background: #f59e0b; }
        
        .action-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .action-button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .action-button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body>
    <!-- Status de conex√£o -->
    <div id="connectionStatus" class="connection-status connecting">
        <span class="status-indicator status-connecting"></span>
        Conectando...
    </div>

    <!-- Bot√£o de diagn√≥stico -->
    <button class="diagnostic-button" id="diagnosticButton" title="Diagn√≥stico do Sistema">
        üîß
    </button>

    <!-- Bot√£o Admin -->
    <button class="admin-button" id="adminButton" title="Painel Administrativo">
        üîß
    </button>

    <!-- MODAL DE VERIFICA√á√ÉO DE IDADE -->
    <div class="age-verification-modal" id="ageVerificationModal">
        <!-- ... (mantenha o conte√∫do do modal de idade original) ... -->
    </div>

    <!-- Cabe√ßalho e conte√∫do principal -->
    <div class="header">
        üçπ BEBCOM DELIVERY üçπ
    </div>

    <!-- ... (mantenha todo o conte√∫do HTML principal do arquivo original) ... -->

    <!-- MODAL DE DIAGN√ìSTICO -->
    <div class="diagnostic-modal" id="diagnosticModal">
        <div class="diagnostic-content">
            <div class="diagnostic-header">
                <h2 class="diagnostic-title">üîç DIAGN√ìSTICO DO SISTEMA</h2>
                <button class="diagnostic-close" id="diagnosticClose">√ó</button>
            </div>
            
            <div id="diagnosticResults">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <p>Executando diagn√≥stico...</p>
                </div>
            </div>
            
            <div style="margin-top: 25px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button class="action-button" onclick="runConnectionTest()">
                    üîÑ Testar Conex√£o
                </button>
                <button class="action-button success" onclick="syncAllFromServer()">
                    üîÑ Sincronizar Dados
                </button>
                <button class="action-button" onclick="testMongoDBSave()">
                    üíæ Testar MongoDB
                </button>
                <button class="action-button danger" onclick="clearLocalData()">
                    üóëÔ∏è Limpar Cache
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ïES PARA PRODU√á√ÉO RENDER
        // ============================================
        const CONFIG = {
            // ‚úÖ URL din√¢mica baseada no ambiente atual
            backendUrl: (() => {
                // Se estiver no Render, use a mesma origem
                if (window.location.hostname.includes('onrender.com')) {
                    return window.location.origin;
                }
                // Fallback para desenvolvimento local
                return 'http://localhost:10000';
            })(),
            
            whatsappNumber: '5514996130369',
            
            // Configura√ß√µes de debug
            debugMode: true,
            
            storeLocation: {
                lat: -22.35892,
                lng: -49.0987233,
                address: "R. Jos√© Henrique Ferraz, 18-10 - Centro, Bauru - SP"
            },

            deliveryRates: {
                baseFee: 5.00,
                perKm: 2.65,
                maxDistance: 15,
                minDistance: 0.5,
                freeDeliveryMin: 100.00
            }
        };

        console.log('üöÄ BebCom Delivery - Produ√ß√£o Render');
        console.log('üåê Frontend URL:', window.location.href);
        console.log('üì° Backend URL:', CONFIG.backendUrl);
        console.log('üîß User Agent:', navigator.userAgent);

        // ============================================
        // ESTADO GLOBAL MELHORADO
        // ============================================
        const state = {
            cart: [],
            currentCategory: 'drinks-whisky',
            deliveryType: 'pickup',
            paymentMethod: null,
            paymentConfirmed: false,
            paymentProcessing: false,
            currentOrderId: null,
            currentPreferenceId: null,
            paymentInterval: null,
            pendingProduct: null,
            pendingFlavors: {},
            currentFlavorStep: null,
            currentButton: null,
            adminAuthenticated: false,
            productAvailability: {},
            flavorAvailability: {},
            // Novos estados para conex√£o
            backendConnected: false,
            mongodbConnected: false,
            lastSyncTime: null
        };

        // ============================================
        // SISTEMA DE CONEX√ÉO E SINCRONIZA√á√ÉO
        // ============================================
        
        async function testConnection() {
            console.log('üîç Testando conex√£o com backend...');
            updateConnectionStatus('connecting');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    timeout: 10000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Backend conectado:', data);
                    
                    // Testar MongoDB
                    try {
                        const mongoResponse = await fetch(`${CONFIG.backendUrl}/api/mongodb-status`);
                        if (mongoResponse.ok) {
                            const mongoData = await mongoResponse.json();
                            state.mongodbConnected = mongoData.success;
                            console.log('üìä MongoDB status:', mongoData);
                        }
                    } catch (mongoError) {
                        console.warn('‚ö†Ô∏è MongoDB n√£o dispon√≠vel:', mongoError);
                        state.mongodbConnected = false;
                    }
                    
                    state.backendConnected = true;
                    updateConnectionStatus('online');
                    return true;
                    
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Falha na conex√£o:', error);
                state.backendConnected = false;
                state.mongodbConnected = false;
                updateConnectionStatus('offline');
                return false;
            }
        }

        function updateConnectionStatus(status) {
            const element = document.getElementById('connectionStatus');
            if (!element) return;
            
            element.className = `connection-status ${status}`;
            
            switch(status) {
                case 'online':
                    element.innerHTML = '<span class="status-indicator status-online"></span> Online';
                    break;
                case 'offline':
                    element.innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                    break;
                case 'connecting':
                    element.innerHTML = '<span class="status-indicator status-connecting"></span> Conectando...';
                    break;
            }
        }

        // ============================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO COM MONGODB
        // ============================================
        
        async function loadProductAvailability() {
            console.log('üì• Carregando disponibilidade de produtos...');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/product-availability`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        state.productAvailability = data.productAvailability || {};
                        localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                        state.lastSyncTime = data.lastUpdated;
                        console.log('‚úÖ Produtos carregados do MongoDB');
                        return true;
                    }
                }
                throw new Error('Resposta inv√°lida');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Fallback para dados locais:', error.message);
                
                // Fallback para localStorage
                const saved = localStorage.getItem('bebcom_product_availability');
                state.productAvailability = saved ? JSON.parse(saved) : {};
                
                // Inicializar produtos faltantes
                Object.keys(products).forEach(category => {
                    products[category].forEach(product => {
                        if (state.productAvailability[product.id] === undefined) {
                            state.productAvailability[product.id] = true;
                        }
                    });
                });
                
                return false;
            }
        }

        async function loadFlavorAvailability() {
            console.log('üì• Carregando disponibilidade de sabores...');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/flavor-availability`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        state.flavorAvailability = data.flavorAvailability || {};
                        localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                        console.log('‚úÖ Sabores carregados do MongoDB');
                        return true;
                    }
                }
                throw new Error('Resposta inv√°lida');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Fallback para sabores locais:', error.message);
                
                const saved = localStorage.getItem('bebcom_flavor_availability');
                state.flavorAvailability = saved ? JSON.parse(saved) : {};
                return false;
            }
        }

        async function syncAllFromServer() {
            console.log('üîÑ Sincronizando dados com MongoDB...');
            
            try {
                const [productsLoaded, flavorsLoaded] = await Promise.all([
                    loadProductAvailability(),
                    loadFlavorAvailability()
                ]);
                
                if (productsLoaded || flavorsLoaded) {
                    updateMenuAvailability();
                    showNotification('‚úÖ Dados sincronizados com MongoDB!', 'success');
                    console.log('üéâ Sincroniza√ß√£o completa');
                    return true;
                } else {
                    showNotification('‚ö†Ô∏è Usando dados locais', 'warning');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                showNotification('‚ùå Erro ao sincronizar: ' + error.message, 'error');
                return false;
            }
        }

        // ============================================
        // SALVAR DADOS NO MONGODB (VERS√ÉO CORRIGIDA)
        // ============================================
        
        async function saveAvailability() {
            console.log('üíæ INICIANDO SALVAMENTO NO MONGODB ATLAS...');
            
            const saveButton = document.querySelector('.save-btn');
            if (!saveButton) {
                console.error('‚ùå Bot√£o n√£o encontrado');
                showNotification('‚ùå Erro interno', 'error');
                return;
            }
            
            // Iniciar loading
            updateButtonLoading(saveButton, true, 'Salvando no MongoDB Atlas...');
            
            try {
                // 1. OBTER SENHA DO INPUT
                const password = document.getElementById('adminPassword').value;
                
                if (!password || password.trim() === '') {
                    throw new Error('Digite a senha administrativa');
                }
                
                console.log('üîë Senha fornecida: [PROTEGIDO]');
                console.log('üì¶ Produtos a salvar:', Object.keys(state.productAvailability).length);
                console.log('üçπ Sabores a salvar:', Object.keys(state.flavorAvailability).length);
                
                // 2. SALVAR PRODUTOS
                console.log('üì§ Enviando produtos para MongoDB...');
                const productResponse = await fetch(`${CONFIG.backendUrl}/api/admin/product-availability/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        productAvailability: state.productAvailability,
                        password: password
                    })
                });
                
                console.log('üì• Resposta produtos - Status:', productResponse.status);
                
                let productResult;
                try {
                    productResult = await productResponse.json();
                } catch (parseError) {
                    console.error('‚ùå Erro ao parsear resposta:', parseError);
                    throw new Error('Resposta inv√°lida do servidor');
                }
                
                if (!productResponse.ok) {
                    console.error('‚ùå Erro na resposta produtos:', productResult);
                    
                    if (productResult.code === 'INVALID_PASSWORD') {
                        throw new Error('Senha administrativa incorreta');
                    } else if (productResult.code === 'NO_PASSWORD') {
                        throw new Error('Senha n√£o fornecida');
                    } else {
                        throw new Error(productResult.error || `Erro ${productResponse.status}`);
                    }
                }
                
                console.log('‚úÖ Produtos salvos:', productResult);
                
                // 3. SALVAR SABORES
                console.log('üì§ Enviando sabores para MongoDB...');
                const flavorResponse = await fetch(`${CONFIG.backendUrl}/api/admin/flavor-availability/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        flavorAvailability: state.flavorAvailability,
                        password: password
                    })
                });
                
                console.log('üì• Resposta sabores - Status:', flavorResponse.status);
                
                let flavorResult;
                try {
                    flavorResult = await flavorResponse.json();
                } catch (parseError) {
                    console.error('‚ùå Erro ao parsear resposta sabores:', parseError);
                    throw new Error('Resposta inv√°lida para sabores');
                }
                
                if (!flavorResponse.ok) {
                    console.error('‚ùå Erro na resposta sabores:', flavorResult);
                    
                    if (flavorResult.code === 'INVALID_PASSWORD') {
                        throw new Error('Senha administrativa incorreta');
                    } else {
                        throw new Error(flavorResult.error || `Erro ${flavorResponse.status}`);
                    }
                }
                
                console.log('‚úÖ Sabores salvos:', flavorResult);
                
                // 4. SUCESSO COMPLETO
                console.log('üéâ TUDO SALVO NO MONGODB ATLAS COM SUCESSO!');
                
                // 5. SALVAR LOCALMENTE TAMB√âM (BACKUP)
                localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                console.log('üíæ Backup local criado');
                
                // 6. ATUALIZAR INTERFACE
                updateMenuAvailability();
                
                // 7. MOSTRAR NOTIFICA√á√ÉO
                showNotification('‚úÖ Dados salvos no MongoDB Atlas! Altera√ß√µes aplicadas para todos os usu√°rios.', 'success');
                
                // 8. SINCRONIZAR PARA CONFIRMAR
                setTimeout(async () => {
                    await syncAllFromServer();
                }, 1000);
                
                // 9. FECHAR MODAL
                setTimeout(() => {
                    closeAdminPanel();
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO AO SALVAR:', error);
                
                let errorMessage = error.message;
                
                if (errorMessage.includes('senha') || errorMessage.includes('Senha') || errorMessage.includes('password')) {
                    errorMessage = '‚ùå Senha incorreta. Fa√ßa login novamente.';
                    
                    // Voltar para tela de senha
                    document.getElementById('passwordSection').style.display = 'block';
                    document.getElementById('adminMain').style.display = 'none';
                    document.getElementById('adminActions').style.display = 'none';
                    state.adminAuthenticated = false;
                    
                    // Focar no campo de senha
                    const passwordInput = document.getElementById('adminPassword');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                    
                } else if (errorMessage.includes('conectar') || errorMessage.includes('offline')) {
                    errorMessage = '‚ùå Servidor offline. Verifique sua conex√£o.';
                    
                    // Salvar localmente como fallback
                    localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                    localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                    showNotification('‚ö†Ô∏è Altera√ß√µes salvas apenas localmente (servidor offline)', 'warning');
                    
                } else {
                    errorMessage = `‚ùå Erro: ${errorMessage}`;
                }
                
                showNotification(errorMessage, 'error');
                
            } finally {
                // Finalizar loading
                updateButtonLoading(saveButton, false);
                console.log('üîö Processo de salvamento finalizado');
            }
        }

        // ============================================
        // FUN√á√ïES DE DIAGN√ìSTICO
        // ============================================
        
        async function runFullDiagnostic() {
            const modal = document.getElementById('diagnosticModal');
            const resultsDiv = document.getElementById('diagnosticResults');
            
            modal.style.display = 'block';
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner" style="margin: 0 auto 20px;"></div><p>Executando diagn√≥stico completo...</p></div>';
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                frontend: {
                    url: window.location.href,
                    hostname: window.location.hostname,
                    origin: window.location.origin,
                    userAgent: navigator.userAgent
                },
                config: {
                    backendUrl: CONFIG.backendUrl,
                    whatsappNumber: CONFIG.whatsappNumber
                },
                state: {
                    cartItems: state.cart.length,
                    backendConnected: state.backendConnected,
                    mongodbConnected: state.mongodbConnected,
                    productCount: Object.keys(state.productAvailability).length,
                    flavorCount: Object.keys(state.flavorAvailability).length
                },
                tests: []
            };
            
            // TESTE 1: Health Check
            try {
                const startTime = Date.now();
                const response = await fetch(`${CONFIG.backendUrl}/health`);
                const endTime = Date.now();
                
                diagnostics.tests.push({
                    name: 'Health Check',
                    url: `${CONFIG.backendUrl}/health`,
                    status: response.status,
                    ok: response.ok,
                    responseTime: `${endTime - startTime}ms`,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                diagnostics.tests.push({
                    name: 'Health Check',
                    error: error.message,
                    ok: false
                });
            }
            
            // TESTE 2: MongoDB Status
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/mongodb-status`);
                const data = await response.json();
                
                diagnostics.tests.push({
                    name: 'MongoDB Status',
                    url: `${CONFIG.backendUrl}/api/mongodb-status`,
                    status: response.status,
                    ok: response.ok,
                    data: data,
                    connected: data.success
                });
            } catch (error) {
                diagnostics.tests.push({
                    name: 'MongoDB Status',
                    error: error.message,
                    ok: false,
                    connected: false
                });
            }
            
            // TESTE 3: Sincroniza√ß√£o
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/sync-all`);
                const data = await response.json();
                
                diagnostics.tests.push({
                    name: 'Sincroniza√ß√£o',
                    url: `${CONFIG.backendUrl}/api/sync-all`,
                    status: response.status,
                    ok: response.ok,
                    data: {
                        productCount: Object.keys(data.productAvailability || {}).length,
                        flavorCount: Object.keys(data.flavorAvailability || {}).length,
                        offline: data.offline
                    }
                });
            } catch (error) {
                diagnostics.tests.push({
                    name: 'Sincroniza√ß√£o',
                    error: error.message,
                    ok: false
                });
            }
            
            // TESTE 4: Teste de salvamento
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/test-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true, timestamp: new Date().toISOString() })
                });
                const data = await response.json();
                
                diagnostics.tests.push({
                    name: 'Teste de Salvamento',
                    url: `${CONFIG.backendUrl}/api/test-save`,
                    status: response.status,
                    ok: response.ok,
                    data: data
                });
            } catch (error) {
                diagnostics.tests.push({
                    name: 'Teste de Salvamento',
                    error: error.message,
                    ok: false
                });
            }
            
            // Exibir resultados
            let html = `
                <h3 style="color: #60a5fa; margin-bottom: 20px;">üìã Resultados do Diagn√≥stico</h3>
                <p><strong>Data/Hora:</strong> ${new Date().toLocaleString()}</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üåê</div>
                        <strong>Frontend</strong><br>
                        <small>${diagnostics.frontend.hostname}</small>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üì°</div>
                        <strong>Backend</strong><br>
                        <small>${diagnostics.config.backendUrl}</small>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üóÑÔ∏è</div>
                        <strong>MongoDB</strong><br>
                        <small>${state.mongodbConnected ? '‚úÖ Conectado' : '‚ùå Offline'}</small>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 5px;">üìä</div>
                        <strong>Dados</strong><br>
                        <small>${state.productCount} produtos</small>
                    </div>
                </div>
                
                <h4 style="color: #94a3b8; margin: 25px 0 15px 0;">üß™ Testes Realizados</h4>
            `;
            
            diagnostics.tests.forEach(test => {
                const statusIcon = test.ok ? '‚úÖ' : '‚ùå';
                const statusClass = test.ok ? 'success' : 'error';
                
                html += `
                    <div class="test-result ${statusClass}">
                        <div class="test-label">
                            ${statusIcon} ${test.name}
                        </div>
                        <div style="font-size: 13px; color: #aaa;">
                            URL: ${test.url}<br>
                            Status: ${test.status || 'N/A'} | Tempo: ${test.responseTime || 'N/A'}
                            ${test.error ? `<br>Erro: ${test.error}` : ''}
                        </div>
                    </div>
                `;
            });
            
            // Status geral
            const allTestsPassed = diagnostics.tests.every(t => t.ok);
            const backendTest = diagnostics.tests.find(t => t.name === 'Health Check');
            const mongoTest = diagnostics.tests.find(t => t.name === 'MongoDB Status');
            
            html += `
                <h4 style="color: #94a3b8; margin: 25px 0 15px 0;">üìä Status Geral</h4>
                <div style="background: ${allTestsPassed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; 
                    padding: 20px; border-radius: 8px; border-left: 4px solid ${allTestsPassed ? '#10b981' : '#ef4444'};">
                    <strong style="color: ${allTestsPassed ? '#10b981' : '#ef4444'};">
                        ${allTestsPassed ? '‚úÖ SISTEMA OPERACIONAL' : '‚ö†Ô∏è PROBLEMAS DETECTADOS'}
                    </strong>
                    
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Backend: ${backendTest?.ok ? '‚úÖ Online' : '‚ùå Offline'}</li>
                        <li>MongoDB: ${mongoTest?.connected ? '‚úÖ Conectado' : '‚ùå Offline'}</li>
                        <li>Produtos: ${state.productCount} itens</li>
                        <li>Sabores: ${state.flavorCount} itens</li>
                        <li>Carrinho: ${state.cart.length} itens</li>
                    </ul>
                </div>
                
                ${!allTestsPassed ? `
                <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
                    <strong style="color: #f59e0b;">üõ†Ô∏è A√ß√µes Recomendadas:</strong>
                    <ol style="margin-top: 10px; padding-left: 20px;">
                        <li>Verifique se o backend est√° online no Render Dashboard</li>
                        <li>Confira os logs do backend (Render ‚Üí Logs)</li>
                        <li>Teste manualmente: <code>curl ${CONFIG.backendUrl}/health</code></li>
                        <li>Verifique a conex√£o com o MongoDB Atlas</li>
                        <li>Se necess√°rio, reinicie o servi√ßo no Render</li>
                    </ol>
                </div>
                ` : ''}
            `;
            
            resultsDiv.innerHTML = html;
            
            // Log completo no console
            console.log('üîç DIAGN√ìSTICO COMPLETO:', diagnostics);
        }

        async function testMongoDBSave() {
            try {
                showNotification('üß™ Testando salvamento no MongoDB...', 'info');
                
                const response = await fetch(`${CONFIG.backendUrl}/api/test-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test: true,
                        message: 'Teste de salvamento do frontend',
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showNotification('‚úÖ Teste de salvamento bem-sucedido!', 'success');
                    console.log('‚úÖ Teste MongoDB:', data);
                } else {
                    throw new Error(data.error || 'Falha no teste');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no teste MongoDB:', error);
                showNotification('‚ùå Falha no teste: ' + error.message, 'error');
            }
        }

        function clearLocalData() {
            if (confirm('Tem certeza que deseja limpar todos os dados locais? Isso n√£o afeta o MongoDB.')) {
                localStorage.removeItem('bebcom_cart');
                localStorage.removeItem('bebcom_product_availability');
                localStorage.removeItem('bebcom_flavor_availability');
                localStorage.removeItem('bebcom_age_verified');
                
                state.cart = [];
                state.productAvailability = {};
                state.flavorAvailability = {};
                
                updateCartDisplay();
                showNotification('üóëÔ∏è Dados locais limpos!', 'info');
            }
        }

        async function runConnectionTest() {
            const result = await testConnection();
            if (result) {
                await syncAllFromServer();
            }
            runFullDiagnostic();
        }

        // ============================================
        // INICIALIZA√á√ÉO DO SISTEMA
        // ============================================
        
        async function init() {
            console.log('üöÄ Inicializando BebCom Delivery v4.0 (Produ√ß√£o Render)');
            
            // Configurar listeners
            setupEventListeners();
            setupAdminListeners();
            
            // Configurar listeners do diagn√≥stico
            document.getElementById('diagnosticButton').addEventListener('click', runFullDiagnostic);
            document.getElementById('diagnosticClose').addEventListener('click', () => {
                document.getElementById('diagnosticModal').style.display = 'none';
            });
            
            // Inicializar verifica√ß√£o de idade
            initAgeVerification();
            
            // S√≥ continuar se idade verificada
            if (!ageVerified) return;
            
            // Configura√ß√µes b√°sicas
            setupPhoneMask();
            setupAutoSave();
            
            // Carregar carrinho local
            loadCartFromLocalStorage();
            
            // Testar conex√£o e carregar dados
            const isConnected = await testConnection();
            
            if (isConnected) {
                // Carregar dados do MongoDB
                await Promise.all([
                    loadProductAvailability(),
                    loadFlavorAvailability()
                ]);
                console.log('‚úÖ Dados carregados do MongoDB Atlas');
            } else {
                console.log('‚ö†Ô∏è Usando dados locais');
            }
            
            // Inicializar componentes visuais
            showCategory('drinks-whisky');
            selectDeliveryType('pickup');
            updateCartDisplay();
            
            console.log('‚úÖ Sistema BebCom Delivery inicializado com sucesso');
        }

        // ============================================
        // FUN√á√ïES UTILIT√ÅRIAS (mantenha as existentes)
        // ============================================
        
        function showNotification(text, type = 'success') {
            // ... (mantenha a fun√ß√£o original)
        }
        
        function updateButtonLoading(button, isLoading, loadingText = 'Processando...') {
            // ... (mantenha a fun√ß√£o original)
        }
        
        // ... (mantenha todas as outras fun√ß√µes do arquivo original)

        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function () {
            init();
        });
    </script>
</body>
</html>
